name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  pr-checks:
    name: PR Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared packages
        run: |
          npm run build --workspace=@portfolio/shared-types
          npm run build --workspace=@portfolio/shared-utils

      - name: Lint all workspaces
        run: npm run lint

      - name: Type check all workspaces
        run: npm run type-check


      - name: Build all workspaces
        run: npm run build

      - name: Check for build artifacts
        run: |
          if [ ! -d "apps/web/.next" ]; then
            echo "❌ Web build failed"
            exit 1
          fi
          if [ ! -d "apps/api/dist" ] && [ ! -d "apps/api/.output" ]; then
            echo "❌ API build failed"
            exit 1
          fi
          echo "✅ All builds successful"

      - name: Comment PR with status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const message = `${emoji} PR Quality Gate ${status}
            
            - Linting: ${status}
            - Type Checking: ${status}
            - Build: ${status}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Check for console.logs (should use proper logging)
        run: |
          echo "Checking for console.log statements..."
          if grep -r "console\.log" apps/web/components apps/web/app --include="*.tsx" --include="*.ts" | grep -v "// eslint-disable"; then
            echo "⚠️  Warning: Found console.log statements. Consider using proper logging."
          else
            echo "✅ No console.log found"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO comments..."
          if grep -r "TODO\|FIXME" apps --include="*.ts" --include="*.tsx"; then
            echo "⚠️  Found TODO/FIXME comments"
          else
            echo "✅ No TODO/FIXME found"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          if grep -r "API_KEY\|SECRET\|PASSWORD" apps --include="*.ts" --include="*.tsx" | grep -v "process.env" | grep -v "// @ts-ignore"; then
            echo "❌ Possible hardcoded secrets found!"
            exit 1
          else
            echo "✅ No hardcoded secrets detected"
          fi
